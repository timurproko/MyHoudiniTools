<?xml version="1.0" encoding="UTF-8"?>
<menuDocument>
    <menu>

        <subMenu id = "ctrl_menu">
            <insertBefore>channels_menu</insertBefore>
            <label>Parameters Control</label>
            <expression>
                <![CDATA[
if hou.getenv("CTRL_NODE"):
    return True
else:
    return False
]]>
            </expression>
            <scriptItem id = "ctrl_parm_spare">
                <label>Set as Spare Parameter</label>
                <expression>
                    <![CDATA[
import hou
node = hou.selectedNodes()
node = node[0]
if node.type().name() == "null":
    return False
else:
    return True
]]>
                </expression>
                <scriptCode>
                    <![CDATA[
def runLater():
    import parms
    parms.parmUtils(kwargs).createRelativeReference(assign_to_definition=False)
import hdefereval
hdefereval.executeDeferred(runLater)
]]>
                </scriptCode>
            </scriptItem>

            <scriptItem id = "ctrl_parm_remove">
                <label>Remove Spare Parameter</label>
                <insertAfter>ctrl_parm_spare</insertAfter>
                <expression>
                    <![CDATA[
import hou
node = hou.selectedNodes()
node = node[0]
if node.type().name() != "null":
    return False
else: 
    return True

if not isinstance(kwargs["parms"][0].parmTemplate(), hou.FolderSetParmTemplate):
    return True
else:
    return False
]]>
                </expression>
                <scriptCode>
                    <![CDATA[
def runLater():
    import parms
    parms.parmUtils(kwargs).deleteParm()
import hdefereval
hdefereval.executeDeferred(runLater)
]]>
                </scriptCode>
            </scriptItem>

            <scriptItem id = "ctrl_referencing">
                <label>Jump to Reference Node</label>
                <insertAfter>ctrl_parm_remove</insertAfter>
                <expression>
                    <![CDATA[
if kwargs["parms"][0].parmsReferencingThis():
    return True
return False
]]>
                </expression>
                <scriptCode>
                    <![CDATA[
def runLater():
    import parms
    ref_node = kwargs["parms"][0].parmsReferencingThis()[-1].node()
    network_editor = hou.ui.paneTabOfType(hou.paneTabType.NetworkEditor)
    if network_editor:
        network_editor.setCurrentNode(ref_node)
        if kwargs["ctrlclick"]:
            network_editor.homeToSelection()
        if kwargs["altclick"]:
            ref_node.setGenericFlag(hou.nodeFlag.Display, 1)
import hdefereval
hdefereval.executeDeferred(runLater)
]]>
                </scriptCode>
            </scriptItem>
        </subMenu>

        <subMenu id="expression_menu">
            <label>Expression</label>
            <addScriptItem id="open_external_editor">
                <label>External Expression Editor</label>
                <parent>expression_menu</parent>
                <insertAfter>edit_expression</insertAfter>
                <context>
                    <expression>
                        <![CDATA[
try:
  import parms_watcher
  return parms_watcher.is_valid_parm(kwargs["parms"][0])
except:
  return False]]></expression>
                </context>
                <scriptCode>
                    <![CDATA[
import parms_watcher
try:
  reload(parms_watcher)
except NameError:
  from importlib import reload
  reload(parms_watcher)
parms_watcher.add_watcher(kwargs["parms"][0])]]>
                </scriptCode>
            </addScriptItem>

            <addScriptItem id="open_external_editor_embedded">
                <label>Edit in External Editor Embedded</label>
                <parent>expression_menu</parent>
                <insertAfter>open_external_editor</insertAfter>
                <context>
                    <expression>
                        <![CDATA[
try:
    import parms_watcher
    return parms_watcher.is_valid_parm(kwargs["parms"][0])
except:
    return False
]]>
                    </expression>
                </context>
                <scriptCode>
                    <![CDATA[
try:
    parm = kwargs["parms"][0]
    node = parm.node()
    if node:
        node.setSelected(False)
except:
    pass

from nodes.scripts import vex_wrangle
from nodes.constants import vex_wrangle as _vex_consts
vex_wrangle.vscEmbed(kwargs["parms"][0], _vex_consts.IDE_NAME)
]]>
                </scriptCode>
            </addScriptItem>

            <addScriptItem id="remove_file_watcher">
                <label>Remove File Watcher</label>
                <parent>expression_menu</parent>
                <insertAfter>open_external_editor_embedded</insertAfter>
                <context>
                    <expression>
                        <![CDATA[
try:
  from HoudiniExprEditor import ParmWatcher
  return ParmWatcher.parm_has_watcher(kwargs["parms"][0])
except:
  return False]]>
                    </expression>
                </context>
                <scriptCode>
                    <![CDATA[
import parms_watcher
try:
  reload(parms_watcher)
except NameError:
  from importlib import reload
  reload(parms_watcher)
parms_watcher.remove_file_watched(kwargs["parms"][0])]]>
                </scriptCode>
            </addScriptItem>
        </subMenu>
    </menu>
</menuDocument>